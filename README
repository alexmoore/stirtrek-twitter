Looking back now in 2013, this isn't the best JavaScript code... but it works. 
It's a bit obtuse down in the internals, so take your time.
